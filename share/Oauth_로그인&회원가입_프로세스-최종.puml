@startuml
'!theme sketchy

'===========================================================
' info
'===========================================================
header last updated: 2023.03.11.
footer Page %page% of %lastpage%
title
    OAuth íšŒì›ê°€ì… & ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤
end title


'===========================================================
' skin
'===========================================================
skinparam padding 3

skinparam roundCorner 40
skinparam actorStyle awesome

'-----------------------------------------------------------
' â˜€ï¸ light
'-----------------------------------------------------------
skinparam default {
    FontColor #26272c
    FontName PT Sans, .AppleSystemUIFont
    FontSize 13
}

skinparam title {
    FontSize 14
    FontColor #26272c
    BackgroundColor #dbdde7
    BorderThickness 0
    BorderRoundCorner 40
}

skinparam participant {
    FontSize 14
    FontStyle bold
    BorderThickness 0
    BackgroundColor #ffaa7a
}

skinparam database {
    FontSize 14
    FontStyle bold
    BackgroundColor #ffaa7a
    BorderColor #2f3036
}

skinparam arrow {
    Color #ff7aa4
    Thickness 2
    MessageAlignment center
}

skinparam sequence {
    GroupBackgroundColor #ff7aa4
    GroupBodyBackgroundColor #dbdde760
    GroupBorderThickness 0

    LifeLineBorderColor #91939c
    LifeLineBorderThickness 1

    BoxBackgroundColor #dbdde760
    BoxBorderColor #2f3036

    DividerBackgroundColor #dbdde230
}
skinparam BoxPadding 5

skinparam note {
    FontColor White
    FontStyle bold

    BackgroundColor #7c9fff
    BorderThickness 0
}

'-----------------------------------------------------------
' ğŸŒ˜ dark
'-----------------------------------------------------------
'
'skinparam backgroundColor #26272c
'skinparam roundCorner 40
'skinparam actorStyle awesome
'
'skinparam default {
'    FontColor White
'    FontName PT Sans, .AppleSystemUIFont
'    FontSize 13
'}
'
'skinparam title {
'    FontSize 14
'    FontColor #26272c
'    BackgroundColor #dbdde7
'    BorderThickness 0
'    BorderRoundCorner 40
'}
'
'skinparam participant {
'    FontSize 14
'    FontStyle bold
'    BorderThickness 0
'    BackgroundColor #fc7f3b
'}
'
'skinparam database {
'    FontSize 14
'    FontStyle bold
'    BackgroundColor #fc7f3b
'    BorderColor #2f3036
'}
'
'skinparam arrow {
'    Color #b5b8c3
'    Thickness 2
'    MessageAlignment center
'}
'
'skinparam sequence {
'    GroupBackgroundColor #f23761
'    GroupBodyBackgroundColor #18181b60
'    GroupBorderThickness 0
'
'    LifeLineBorderColor #91939c
'    LifeLineBorderThickness 1
'
'    BoxBackgroundColor #2f3036
'    BoxBorderColor #2f3036
'
'    DividerBackgroundColor #2f303680
'    DividerBorderColor Gray
'    DividerBorderThickness 1
'}
'skinparam BoxPadding 5
'
'skinparam note {
'    FontColor White
'    FontStyle bold
'    BackgroundColor #4d90ff
'    BorderThickness 0
'}


'===========================================================
' box
'===========================================================
'-----------------------------------------------------------
' ğŸŒ˜ dark
'-----------------------------------------------------------
'box Foodage Client
'    participant "Client" as client #f2b120
'end box

'participant "Oauth Web" as a_client #68be00
'participant "Oauth Server" as a_server #68be00

'box Foodage Server
'    participant "Server" as server #f98c0b
'    database db #f98c0b
'end box

'-----------------------------------------------------------
' â˜€ï¸ light
'-----------------------------------------------------------
box Foodage Client
    participant "Client" as client #ffd451
end box

participant "Oauth Web" as a_client #83ea9d
participant "Oauth Server" as a_server #83ea9d

box Foodage Server
    participant "Server" as server #ffb36f
    database db #ffb36f
end box

autonumber


'===========================================================
' contents
'===========================================================
|||
== ã…¤íšŒì›ê°€ì… & ë¡œê·¸ì¸   ==

client -> a_client: Oauth ë¡œê·¸ì¸ sdk ì‹¤í–‰

'ì„œë¹„ìŠ¤ íšŒì›ê°€ì…
group íšŒì›ê°€ì…* [ê¸°ì¡´ ê°€ì…ìë©´ í•„ìš” X]
    a_client -> a_server: ì•½ê´€ ë™ì˜ í™”ë©´ ìš”ì²­
    a_server --> a_client: ì•½ê´€ ë™ì˜ í™”ë©´ ì¶œë ¥
    a_client -> a_server: ì•½ê´€ ë™ì˜ ì™„ë£Œ
end

a_client -> a_server: Oauth ë¡œê·¸ì¸ ì™„ë£Œ

a_server -> server: Redirect URIë¡œ ì¸ê°€ì½”ë“œ(auth code) ì „ë‹¬
server --> server: Redirect URIì™€ ë§¤í•‘ë˜ëŠ” get api ì‘ì„±í•˜ì—¬\nì¸ê°€ì½”ë“œ receive

group í† í° ë°œê¸‰*
''' at ë°œê¸‰
server -> a_server: ì¸ê°€ì½”ë“œë¡œ Oauth token ë°œê¸‰ ìš”ì²­
a_server --> server: Oauth token ë°œê¸‰
end

''' atë¡œ ì‚¬ìš©ì ì •ë³´ í™•ì¸
server -> a_server: Oauth tokenìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ìš”ì²­
a_server --> server: ì‚¬ìš©ì ì •ë³´ ì‘ë‹µ (ì´ë©”ì¼, ì´ë¦„ ë“±)
server -> db: í•´ë‹¹ ì‚¬ìš©ìì˜ ê°€ì… ì—¬ë¶€ í™•ì¸
db --> db: ì´ë©”ì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸

'ì„œë¹„ìŠ¤ ë¡œê·¸ì¸
group ë¡œê·¸ì¸* [case 1]
    db --> server: ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼(ê¸°ì¡´ ê°€ì…ì)ì¼ ê²½ìš°
    server --> server: ì„œë²„ Access Token(ì´í•˜ Aãƒ»T) ë°œê¸‰
    server --> server: ì„œë²„ Refresh Token(ì´í•˜ Rãƒ»T) ë°œê¸‰
    server --> client: ë©”ì¸ í˜ì´ì§€ë¡œ redirect\n& <Response Header Cookie>ì— Aãƒ»T, Rãƒ»T ë°˜í™˜
    client -> client: ë¡œê·¸ì¸ ì„±ê³µ
end

'ì„œë¹„ìŠ¤ íšŒì›ê°€ì…
group íšŒì›ê°€ì…* [case 2]
    db --> server: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì´ë©”ì¼(ì‹ ê·œ íšŒì›)ì¼ ê²½ìš°
    server -> db: ì‚¬ìš©ì ì„ì‹œ ê°€ì… ìš”ì²­
    db --> db: insert oauth_id, account_email, state(TEMP_JOIN)
    db --> server: ì‚¬ìš©ì ì„ì‹œ ê°€ì… ì™„ë£Œ
    server -> client: íšŒì›ê°€ì… í˜ì´ì§€ë¡œ redirect\n& <Response Header(Cookie)>ì— Oauth ì„œë²„ ì¢…ë¥˜ì™€ Oauth token ë°˜í™˜
    client --> client: ì¶”ê°€ ê°€ì… ì •ë³´ ì…ë ¥ í™”ë©´ ë…¸ì¶œ
      note right: ex. ë§ˆì§€ë§‰ìœ¼ë¡œ, íšŒì›ê°€ì…ì— í•„ìš”í•œ ì¶”ê°€ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” ë“±
    client -> server: íšŒì›ê°€ì… ì™„ë£Œ ìš”ì²­ (RequestBody : ì‚¬ìš©ì ì´ë©”ì¼, ì¶”ê°€ ì •ë³´, Oauth ì„œë²„ ì¢…ë¥˜, Oauth token)
    server -> a_server: Oauth tokenìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ìš”ì²­
    a_server --> server: ì‚¬ìš©ì ì •ë³´ ì‘ë‹µ (ì´ë©”ì¼, ì´ë¦„ ë“±)
    server -> db: í•´ë‹¹ ì‚¬ìš©ìì˜ ì„ì‹œ ê°€ì… ìƒíƒœ í™•ì¸
    db --> db: ì‚¬ìš©ìì˜ stateê°€ TEMP_JOINì´ ë§ëŠ”ì§€ í™•ì¸
    db --> server: ì„ì‹œ ê°€ì… ìƒíƒœê°€ ë§ì„ ê²½ìš°
    server -> db: ì¶”ê°€ íšŒì›ê°€ì… ì •ë³´ë¡œ ì‚¬ìš©ì ì •ë³´ update
    db --> db: nickname, character_type, last_login ë“± update
    db --> server: ì •ë³´ ì €ì¥ ì™„ë£Œ
    server --> server: ì„œë²„ Access Token(ì´í•˜ Aãƒ»T) ë°œê¸‰
    server --> server: ì„œë²„ Refresh Token(ì´í•˜ Rãƒ»T) ë°œê¸‰
    server -> client: Aãƒ»T, Rãƒ»Tì™€ 201 Created ë°˜í™˜
    client -> client: íšŒì›ê°€ì… ì™„ë£Œ ë° ë¡œê·¸ì¸ ì²˜ë¦¬
end

|||

@enduml
